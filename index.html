<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#007bff">
  <title>Wheel Loader TMS</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    .judul-besar {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0 20px;
    }
    
    h2, h3, label {
      font-size: 16px;
      font-weight: bold;
      margin: 8px 0 5px;
    }
    
    select {
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 6px;
      width: 100%;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      background-color: white;
    }
    
    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #888;
      margin: 4px 0;
      width: 100%;
      min-height: 44px;
      transition: all 0.2s ease;
    }
    
    .button-group {
      margin: 4px 0;
    }
    
    .button-group button {
      min-width: auto;
    }
    
    .button-group button:disabled {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .grid-3col {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .primary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .primary-grid button {
      background-color: #28a745; /* Hijau untuk Primary Work */
      color: white;
      border: none;
    }
    
    .primary-grid button.active {
      background-color: #1e7e34; /* Hijau lebih gelap saat aktif */
      transform: scale(0.98);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .secondary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .secondary-grid button {
      background-color: #17a2b8; /* Biru untuk Secondary Work */
      color: white;
      border: none;
    }
    
    .secondary-grid button.active {
      background-color: #117a8b; /* Biru lebih gelap saat aktif */
      transform: scale(0.98);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .hasil, .resume {
      background: #f9f9f9;
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 8px;
      min-width: 500px;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    
    .charts {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }
    
    .charts canvas {
      width: 100% !important;
      height: auto !important;
    }
    
    .fill-factor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    
    .fill-factor-grid button {
      background-color: #e0f0ff;
      color: #004b7f;
      border: 1px solid #007bff;
      font-weight: bold;
      border-radius: 8px;
      padding: 10px 0;
      transition: background-color 0.2s ease;
      min-height: 50px;
    }
    
    .fill-factor-grid button.active {
      background-color: #007bff;
      color: white;
    }
    
    .fill-factor-grid button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    #loginContainer {
      width: 100%;
      max-width: 100%;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }
    
    .login-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .login-logo {
      width: 100px;
      height: auto;
      object-fit: contain;
    }
    
    .login-form {
      width: 100%;
    }
    
    .login-form input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      min-height: 44px;
    }
    
    .login-form button {
      width: 100%;
      padding: 12px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    #stepTimer {
      display: none;
      font-weight: bold;
      font-size: 16px;
      padding: 8px 12px;
      border: 2px solid #007bff;
      border-radius: 8px;
      background-color: #f0f8ff;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin: 10px 0;
    }
    
    .view-container {
      display: none;
      width: 100%;
      max-width: 100%;
      padding: 0 5px;
    }
    
    .nav-button {
      margin: 10px 0;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    
    #iosInstallPrompt {
      display: none;
      padding: 12px;
      background: #fef7d1;
      border: 1px solid #e6c200;
      font-size: 14px;
      margin-top: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    #truckCounterContainer {
      display: block;
      margin: 10px 0;
    }
    
    #truckCounterContainer button {
      display: inline-block;
      width: 50px;
      margin: 0 5px;
    }
    
    #truckCount {
      display: inline-block;
      min-width: 30px;
      text-align: center;
      font-weight: bold;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .button-row button {
      flex: 1;
    }
    
    .offline-mode {
      position: relative;
    }
    
    .offline-mode::after {
      content: "OFFLINE";
      position: fixed;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 1000;
      font-weight: bold;
    }
    
    .offline-mode button:not(.nav-button) {
      opacity: 0.9;
      border: 1px dashed #999;
    }
    
    @media (min-width: 768px) {
      body {
        padding: 15px;
        max-width: 960px;
        margin: 0 auto;
      }
      
      .judul-besar {
        font-size: 36px;
      }
      
      .charts {
        flex-direction: row;
      }
      
      .charts canvas {
        width: 48% !important;
      }
      
      #loginContainer {
        max-width: 700px;
        margin: 50px auto;
        padding: 30px;
      }
      
      .login-content {
        flex-direction: row;
        align-items: center;
        gap: 30px;
      }
      
      .login-logo {
        width: 120px;
      }
    }
  </style>
</head>
<body onload="initializeForm()">

<!-- View 1: Login -->
<div id="loginView" class="view-container">
  <div id="loginContainer">
    <div class="login-content">
      <div class="logo-container">
        <img src="./logo.png" alt="Logo" class="login-logo" />
      </div>
      <div class="login-form">
        <h2>Login</h2>
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" />
        </div>
        <div class="form-group" style="position: relative;">
          <label for="password">Password:</label>
          <input type="password" id="password" style="padding-right: 40px;" />
          <span onclick="togglePassword()" style="position: absolute; right: 10px; bottom: 8px; cursor: pointer; font-size: 18px;">üëÅÔ∏è</span>
        </div>
        <button onclick="checkLogin()">Login</button>
        <p id="loginError" style="color: red;"></p>
      </div>
    </div>
  </div>
</div>

<!-- View 2: Input Alat -->
<div id="inputAlatView" class="view-container">
  <h1 class="judul-besar">Wheel Loader TMS</h1>
  
  <label>Model Wheel Loader:</label>
  <select id="typeAlat">
    <option value="">-- Pilih Model --</option>
    <option value="WA1200-6">WA1200-6</option>
    <option value="WA900-8">WA900-8</option>
 </select>

  <label>Kapasitas Bucket (m¬≥):</label>
  <select id="kapasitasBucket">
    <option value="">-- Pilih Kapasitas --</option>
    <option value="37.5">37.5 m¬≥</option>
    <option value="24">24 m¬≥</option>
  </select>

  <label>Metode Loading:</label>
  <select id="metodeLoading">
    <option value="">-- Pilih Metode --</option>
    <option>V-Shape Loading</option>
    <option>Cross Loading</option>
    <option>Stockpile Loading</option>
  </select>

  <label>Jenis Material:</label>
  <select id="jenisMaterial">
    <option value="">-- Pilih Material --</option>
    <option value="0.9">Batubara (0.9 ton/m¬≥)</option>
    <option value="1.5">Overburden (1.5 ton/m¬≥)</option>
    <option value="1.8">Tanah Liat (1.8 ton/m¬≥)</option>
    <option value="1.6">Material Campuran (1.6 ton/m¬≥)</option>
    <option value="2.0">Batu Kapur (2.0 ton/m¬≥)</option>
  </select>
  
  <button id="btnNextToOperation" class="nav-button" onclick="showOperationView()" disabled>Lanjut ke Operasi ‚Üí</button>
</div>

<!-- View 3: Operation -->
<div id="operationView" class="view-container">
  <h1 class="judul-besar">Wheel Loader TMS</h1>
  
  <div class="button-row">
    <button id="btnStart" onclick="startSession()" disabled>‚ñ∂Ô∏è Mulai</button>
    <button id="btnPause" onclick="togglePause()" disabled>‚è∏Ô∏è Pause</button>
    <button id="btnEdit" onclick="startEdit()" disabled>‚úèÔ∏è Edit</button>
  </div>

  <div id="truckCounterContainer">
    <label><strong>Truck Counter:</strong></label><br>
    <button onclick="updateTruckCount(-1)" id="btnMinus" disabled>-</button>
    <span id="truckCount">0</span>
    <button onclick="updateTruckCount(1)" id="btnPlus" disabled>+</button>
  </div>

  <div id="stepTimer">
    ‚è±Ô∏è <span id="stepTimerValue">0.0</span> detik
  </div>

  <h3>Bucket Fill Factor:</h3>
  <div class="fill-factor-grid" id="fillFactors">
    <button onclick="setFill(this, 0.7)" disabled>0.7</button>
    <button onclick="setFill(this, 0.8)" disabled>0.8</button>
    <button onclick="setFill(this, 0.9)" disabled>0.9</button>
    <button onclick="setFill(this, 1.0)" class="active" disabled>1.0</button>
    <button onclick="setFill(this, 1.1)" disabled>1.1</button>
    <button onclick="setFill(this, 1.2)" disabled>1.2</button>
  </div>

  <h3>Primary Work:</h3>
  <div class="primary-grid" id="primaryButtons">
    <!-- Row 1 -->
    <button onclick="addStep(this, 'Primary Work', 'Digging')" disabled>‚Üí Digging</button>
    <button onclick="addStep(this, 'Primary Work', 'Reverse Loaded')" disabled>‚Üì Reverse Loaded</button>
    
    <!-- Row 2 -->
    <button onclick="addStep(this, 'Primary Work', 'Forward Empty')" disabled>‚Üë Forward Empty</button>
    <button onclick="addStep(this, 'Primary Work', 'Forward Loaded')" disabled>‚Üì Forward Loaded</button>
    
    <!-- Row 3 -->
    <button onclick="addStep(this, 'Primary Work', 'Reverse Empty')" disabled>‚Üë Reverse Empty</button>
    <button onclick="addStep(this, 'Primary Work', 'Dumping')" disabled>‚Üê Dumping</button>
  </div>

  <h3>Secondary Work:</h3>
  <div class="secondary-grid" id="secondaryButtons">
    <!-- Row 1 -->
    <button onclick="addStep(this, 'Secondary Work', 'Push Material')" disabled>Push Material</button>
    <button onclick="addStep(this, 'Secondary Work', 'Wait for Truck')" disabled>Wait for Truck</button>
    
    <!-- Row 2 -->
    <button onclick="addStep(this, 'Secondary Work', 'Idle')" disabled>Idle</button>
    <button onclick="addStep(this, 'Secondary Work', 'Cleaning')" disabled>Cleaning</button>
    
    <!-- Row 3 -->
    <button onclick="addStep(this, 'Secondary Work', 'Positioning')" disabled>Positioning</button>
    <button onclick="addStep(this, 'Secondary Work', 'Others')" disabled>Others</button>
  </div>

  <button id="btnSelesai" onclick="selesaiSession()" disabled>‚úÖ Selesai</button>
  <button id="btnSummary" onclick="hitungProduksi()" disabled>üìä Summary</button>
  <button id="btnExportPDF" onclick="exportPDF()" disabled>üßæ Export ke PDF</button>
  <button id="btnExportExcel" onclick="exportExcel()" disabled>üìÑ Export ke Excel</button>
  <button id="btnExportSheets" onclick="exportToGoogleSheets()" disabled>üì§ Export ke Google Sheets</button>
  <button id="btnBackToInput" class="nav-button" onclick="showInputAlatView()" disabled>Kembali ke Input Awal</button>

  <div class="hasil" id="output"></div>
  <div class="resume" id="resume"></div>
  <div class="charts">
    <canvas id="pieChart"></canvas>
    <canvas id="barChart"></canvas>
  </div>
</div>

<!-- iOS install prompt -->
<div id="iosInstallPrompt">
  üì± Untuk menginstal aplikasi ini di iPhone, tap tombol <strong>Bagikan</strong> (ikon ‚¨ÜÔ∏è di bawah), lalu pilih <strong>Tambahkan ke Layar Utama</strong>.
</div>

<script>
// View management functions
function showLoginView() {
  document.getElementById('loginView').style.display = 'block';
  document.getElementById('inputAlatView').style.display = 'none';
  document.getElementById('operationView').style.display = 'none';
}

function showInputAlatView() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('inputAlatView').style.display = 'block';
  document.getElementById('operationView').style.display = 'none';
}

function showOperationView() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('inputAlatView').style.display = 'none';
  document.getElementById('operationView').style.display = 'block';
}

// Application variables
let logs = [], currentFill = 1.0, started = false, lastTime = null, lastLabel = null;
let stepTimerInterval = null;
let stepStartTime = null;
let truckCount = 0;
let paused = false;
let correctionIndex = 0;
let stepElapsedTime = 0;
let pauseStartTime = null;
let totalPausedTime = 0;
let editing = false;

// Offline data management
let offlineData = {
  logs: [],
  truckCount: 0,
  currentFill: 1.0,
  lastState: null
};

// Initialize the app
function initializeForm() {
  // 1. Set initial view
  document.getElementById('loginView').style.display = 'block';
  document.getElementById('inputAlatView').style.display = 'none';
  document.getElementById('operationView').style.display = 'none';
  console.log('Initial views configured');

  // 2. Register Service Worker for offline capability
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('ServiceWorker registered with scope:', registration.scope);
        registration.update();
        
        // Check if content is cached
        caches.match('./index.html')
          .then(response => {
            if (response) {
              console.log('App is cached for offline use');
            } else {
              console.log('No cache found, will cache on next load');
            }
          });
      })
      .catch(err => {
        console.error('ServiceWorker registration failed:', err);
      });
  }

  // 3. Check offline status and setup event listeners
  checkOfflineStatus();
  window.addEventListener('online', handleNetworkChange);
  window.addEventListener('offline', handleNetworkChange);
  console.log('Network listeners setup');

  // 4. Load any saved offline data
  loadOfflineData();

  // 5. Check for saved login credentials
  const saved = localStorage.getItem("loginUser");
  if (saved) {
    try {
      const { user, pass, time } = JSON.parse(saved);
      const now = Date.now();
      const diffHours = (now - time) / (1000 * 60 * 60);

      if (diffHours <= 24) {
        document.getElementById("username").value = user;
        document.getElementById("password").value = pass;
        console.log('Loaded saved credentials');
      } else {
        localStorage.removeItem("loginUser");
        console.log('Expired credentials cleared');
      }
    } catch (e) {
      console.error("Error parsing saved login", e);
    }
  }

  // 6. iOS install prompt
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase());
  const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
  if (isIOS && !isInStandaloneMode) {
    document.getElementById('iosInstallPrompt').style.display = 'block';
    console.log('Showing iOS install prompt');
  }

  // 7. Setup equipment type dropdown
  document.getElementById("typeAlat").addEventListener("change", function() {
    const type = this.value;
    const bucketSelect = document.getElementById("kapasitasBucket");
    bucketSelect.innerHTML = '<option value="">-- Pilih Kapasitas --</option>';

    let options = [];
    if (type === "WA1200-6") {
      options = [37.5];
    } else if (type === "WA900-8") {
      options = [24];
    }

    if (options.length > 0) {
      options.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val.toString().replace(".", ",") + " m¬≥";
        bucketSelect.appendChild(opt);
      });
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "-- Isi Manual --";
      bucketSelect.appendChild(opt);
    }
    cekForm();
  });

  // 8. Setup other dropdown listeners
  ['kapasitasBucket', 'metodeLoading', 'jenisMaterial'].forEach(id => {
    document.getElementById(id).addEventListener('change', cekForm);
  });

  // 9. Initial form check
  cekForm();
  console.log('Form initialization complete');
}

// Offline functionality
function checkOfflineStatus() {
  if (!navigator.onLine) {
    document.body.classList.add('offline-mode');
    console.log('Aplikasi dalam mode offline');
  } else {
    document.body.classList.remove('offline-mode');
  }
}

function handleNetworkChange() {
  checkOfflineStatus();
  if (navigator.onLine) {
    console.log('Koneksi kembali');
    syncOfflineData();
  } else {
    console.log('Kehilangan koneksi');
    if (started) {
      saveOfflineData();
    }
  }
}

function saveOfflineData() {
  offlineData = {
    logs: logs,
    truckCount: truckCount,
    currentFill: currentFill,
    lastState: {
      lastTime: lastTime,
      lastLabel: lastLabel,
      stepElapsedTime: stepElapsedTime,
      totalPausedTime: totalPausedTime
    }
  };
  localStorage.setItem('tmsOfflineData', JSON.stringify(offlineData));
  console.log('Data disimpan untuk offline');
}

function loadOfflineData() {
  const savedData = localStorage.getItem('tmsOfflineData');
  if (savedData) {
    offlineData = JSON.parse(savedData);
    logs = offlineData.logs;
    truckCount = offlineData.truckCount;
    currentFill = offlineData.currentFill;
    
    if (offlineData.lastState) {
      lastTime = offlineData.lastState.lastTime;
      lastLabel = offlineData.lastState.lastLabel;
      stepElapsedTime = offlineData.lastState.stepElapsedTime;
      totalPausedTime = offlineData.lastState.totalPausedTime;
    }
    
    document.getElementById('truckCount').innerText = truckCount;
    console.log('Data offline dimuat');
    
    // Clear saved data after loading
    localStorage.removeItem('tmsOfflineData');
  }
}

function syncOfflineData() {
  // Placeholder for any sync logic with server
  console.log('Menyinkronkan data offline...');
}

// Auto-save every 30 seconds when offline
setInterval(() => {
  if (!navigator.onLine && started) {
    saveOfflineData();
  }
}, 30000);

function cekForm() {
  const filled = document.getElementById('typeAlat').value &&
               document.getElementById('kapasitasBucket').value &&
               document.getElementById('metodeLoading').value &&
               document.getElementById('jenisMaterial').value;
  document.getElementById('btnStart').disabled = !filled;
  document.getElementById('btnNextToOperation').disabled = !filled;
}

function checkLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  
  if (user === 'Insoper_UT' && pass === 'dediKASI') {
    const now = new Date().getTime();
    localStorage.setItem("loginUser", JSON.stringify({ user, pass, time: now }));
    showInputAlatView();
  } else {
    document.getElementById('loginError').innerText = 'Username atau password salah';
  }
}

function togglePassword() {
  const input = document.getElementById("password");
  input.type = input.type === "password" ? "text" : "password";
}

function setFill(btn, val) {
  if (!started) return;
  currentFill = val;
  document.querySelectorAll('#fillFactors button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function startSession() {
  started = true;
  lastTime = null;
  lastLabel = null;
  logs = [];
  truckCount = 0;
  document.getElementById('truckCount').innerText = truckCount;

  document.querySelectorAll('#operationView button').forEach(btn => {
    if (btn.id !== 'btnStart') btn.disabled = true;
  });

  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnEdit').disabled = true;
  document.getElementById('btnPause').disabled = true;

  // Aktifkan counter
  document.getElementById('truckCounterContainer').style.display = 'block';
  document.getElementById('btnPlus').disabled = false;
  document.getElementById('btnMinus').disabled = false;
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.disabled = false);
  correctionIndex = 0;
}

function addStep(btn, category, item) {
  if (!started) return;

  document.getElementById("btnPause").disabled = false;

  if (editing) {
    lastLabel = { category, item };
    editing = false;

    // Nonaktifkan lagi tombol pilihan
    document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.disabled = true);

    alert(`Langkah telah diperbaiki menjadi: ${item}`);
    return;
  }

  const now = Date.now();

  if (lastTime !== null) {
    // Pastikan totalPausedTime sudah terupdate jika sedang pause sebelumnya
    if (paused && pauseStartTime) {
      totalPausedTime += (now - pauseStartTime);
      pauseStartTime = null;
    }

    // Hitung durasi AKTIF saja (tidak termasuk waktu pause)
    const durasiAktif = ((now - lastTime) - totalPausedTime) / 1000;

    logs.push({
      category: lastLabel.category,
      item: lastLabel.item,
      durasi: durasiAktif,
      fillFactor: currentFill
    });
  }

  // Siapkan langkah baru
  lastTime = now;
  lastLabel = { category, item };

  // Reset untuk langkah berikutnya
  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;

  resetStepTimer();

  // Reset tampilan tombol
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const fillButtons = document.querySelectorAll('#fillFactors button');
  if (item === 'Digging' || item === 'Reverse Loaded' || item === 'Forward Loaded') {
    fillButtons.forEach(b => b.disabled = false);
  } else {
    fillButtons.forEach(b => b.disabled = true);
  }
}

function selesaiSession() {
  if (!started || lastTime === null || lastLabel === null) return;
  const now = Date.now();

  // Jika masih dalam kondisi pause, hitung totalPausedTime terakhir
  if (paused && pauseStartTime) {
    totalPausedTime += (now - pauseStartTime);
    pauseStartTime = null;
  }

  // Hitung durasi AKTIF saja (tidak termasuk waktu pause)
  const durasiAktif = ((now - lastTime) - totalPausedTime) / 1000;

  logs.push({
    category: lastLabel.category,
    item: lastLabel.item,
    durasi: durasiAktif,
    fillFactor: currentFill
  });

  started = false;
  lastTime = null;
  lastLabel = null;

  document.querySelectorAll('#operationView button').forEach(b => b.disabled = true);
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnSummary').disabled = false;
  document.getElementById('btnBackToInput').disabled = false;

  // Nonaktifkan counter dan timer
  document.getElementById('btnPlus').disabled = true;
  document.getElementById('btnMinus').disabled = true;
  document.getElementById('truckCounterContainer').style.display = 'none';
  clearInterval(stepTimerInterval);
  document.getElementById('stepTimer').style.display = 'none';

  // Nonaktifkan tombol pause
  paused = false;
  document.getElementById("btnPause").disabled = true;
  document.getElementById("btnPause").innerText = "‚è∏Ô∏è Pause";

  const btnStart = document.getElementById('btnStart');
  btnStart.innerText = "üîÑ Reset";
  btnStart.onclick = resetSession;
}

function resetSession() {
  // Reset variabel
  logs = [];
  currentFill = 1.0;
  started = false;
  lastTime = null;
  lastLabel = null;
  truckCount = 0;
  correctionIndex = 0;
  editing = false;

  stepElapsedTime = 0;
  pauseStartTime = null;
  totalPausedTime = 0;

  // Kosongkan tampilan
  document.getElementById('output').innerHTML = '';
  document.getElementById('resume').innerHTML = '';

  // Reset grafik
  const pieChartCanvas = document.getElementById("pieChart");
  const barChartCanvas = document.getElementById("barChart");
  if (pieChartCanvas && pieChartCanvas.chart) pieChartCanvas.chart.destroy();
  if (barChartCanvas && barChartCanvas.chart) barChartCanvas.chart.destroy();

  // Reset tombol mulai
  const btnStart = document.getElementById('btnStart');
  btnStart.innerText = "‚ñ∂Ô∏è Mulai";
  btnStart.onclick = startSession;
  btnStart.disabled = true;

  // Reset timer
  document.getElementById('stepTimerValue').innerText = "0.0";
  document.getElementById('stepTimer').style.display = "none";

  // Nonaktifkan export
  document.getElementById("btnExportPDF").disabled = true;
  document.getElementById("btnExportExcel").disabled = true;
  document.getElementById("btnExportSheets").disabled = true;
  document.getElementById('btnBackToInput').disabled = true;

  // Nonaktifkan fill factor active
  document.querySelectorAll('#fillFactors button').forEach(btn => {
    btn.classList.remove('active');
    if (btn.innerText === "1.0") btn.classList.add('active');
  });

  // Cek form lagi
  cekForm();
}

function updateTruckCount(delta) {
  if (!started) return;
  truckCount += delta;
  if (truckCount < 0) truckCount = 0;
  document.getElementById('truckCount').innerText = truckCount;
}

function resetStepTimer() {
  clearInterval(stepTimerInterval);
  stepStartTime = Date.now();
  document.getElementById('stepTimer').style.display = 'block';

  stepTimerInterval = setInterval(() => {
    const now = Date.now();
    const elapsed = ((now - stepStartTime) / 1000) + stepElapsedTime;
    document.getElementById('stepTimerValue').innerText = elapsed.toFixed(1);
  }, 100);
}

function togglePause() {
  // Only allow pausing if a work step has been selected
  if (!paused && (!lastLabel || !lastTime)) {
    alert("Silakan pilih langkah kerja terlebih dahulu sebelum pause");
    return;
  }

  // Toggle pause state
  paused = !paused;
  
  // Update button text
  document.getElementById("btnPause").innerText = paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
  
  // Enable/disable edit button
  document.getElementById("btnEdit").disabled = !paused;

  // Get all relevant buttons
  const primaryButtons = document.querySelectorAll('#primaryButtons button');
  const secondaryButtons = document.querySelectorAll('#secondaryButtons button');
  const fillFactorButtons = document.querySelectorAll('#fillFactors button');

  if (paused) {
    // When pausing:
    // Disable all work buttons
    primaryButtons.forEach(btn => btn.disabled = true);
    secondaryButtons.forEach(btn => btn.disabled = true);
    fillFactorButtons.forEach(btn => btn.disabled = true);
    
    // Enable finish button
    document.getElementById('btnSelesai').disabled = false;

    // Record pause start time
    pauseStartTime = Date.now();
    
    // Stop the timer
    clearInterval(stepTimerInterval);
    
    // Calculate elapsed time
    const now = Date.now();
    stepElapsedTime += (now - stepStartTime) / 1000;
    
    // Update timer display
    document.getElementById('stepTimer').style.display = 'block';
    document.getElementById('stepTimerValue').innerText = stepElapsedTime.toFixed(1);
  } else {
    // When resuming:
    // Calculate total paused time
    if (pauseStartTime) {
      totalPausedTime += (Date.now() - pauseStartTime);
      pauseStartTime = null;
    }

    if (started) {
      // Re-enable appropriate buttons
      primaryButtons.forEach(btn => btn.disabled = false);
      secondaryButtons.forEach(btn => btn.disabled = false);
      
      // Only enable fill factor buttons for specific steps
      if (lastLabel && (lastLabel.item === "Digging" || lastLabel.item === "Reverse Loaded" || lastLabel.item === "Forward Loaded")) {
        fillFactorButtons.forEach(btn => btn.disabled = false);
      }
    }
    
    // Restart the timer
    resetStepTimer();
    
    // Disable finish button during operation
    document.getElementById('btnSelesai').disabled = true;
  }
}

function startEdit() {
  if (!paused || !lastLabel) return;

  editing = true;
  document.querySelectorAll('#primaryButtons button, #secondaryButtons button').forEach(b => b.disabled = false);
  alert("Silakan pilih langkah baru untuk mengganti langkah aktif sebelumnya.");
}

function hitungProduksi() {
  if (logs.length === 0) {
    alert("Belum ada data aktivitas yang dicatat.");
    return;
  }
  
  const typeAlat = document.getElementById("typeAlat").value;
  const kapasitas = document.getElementById("kapasitasBucket").value;
  const metode = document.getElementById("metodeLoading").value;
  const material = document.getElementById("jenisMaterial").value;
  const materialName = document.getElementById("jenisMaterial").selectedOptions[0].text;

  const bucket = parseFloat(kapasitas) || 1;
  const density = parseFloat(material) || 1;
  const primary = logs.filter(l => l.category === 'Primary Work');
  const secondary = logs.filter(l => l.category === 'Secondary Work');
  const totalPrimary = primary.reduce((a,b) => a + b.durasi, 0);
  const totalSecondary = secondary.reduce((a,b) => a + b.durasi, 0);
  
  // Hitung cycle time berdasarkan siklus Dumping
  const dumpCount = primary.filter(l => l.item === 'Dumping').length;
  const avgCycleTime = dumpCount > 0 ? totalPrimary / dumpCount : 0;
  
  const efficiency = totalPrimary / (totalPrimary + totalSecondary);
  const avgFill = logs.reduce((a,b)=>a+b.fillFactor,0) / logs.length;
  
  // Hitung produktivitas dalam ton/jam
  const produksiTon = (bucket * avgFill * 3600 * efficiency * density) / (avgCycleTime || 1);

  // Analisis waktu per langkah
  const avg = arr => arr.length > 0 ? arr.reduce((a,b)=>a+b.durasi,0)/arr.length : 0;
  const suggestions = [];
  
  const digging = primary.filter(l => l.item === 'Digging');
  const reverseLoaded = primary.filter(l => l.item === 'Reverse Loaded');
  const forwardLoaded = primary.filter(l => l.item === 'Forward Loaded');
  const dumping = primary.filter(l => l.item === 'Dumping');
  const reverseEmpty = primary.filter(l => l.item === 'Reverse Empty');
  const forwardEmpty = primary.filter(l => l.item === 'Forward Empty');
  
  if (efficiency < 0.85) suggestions.push("‚ö†Ô∏è Primary work < 85%. Tingkatkan efisiensi loading, kurangi secondary time.");
  if (avg(digging) > 10) suggestions.push("‚ö†Ô∏è Digging > 10 detik. Optimalkan kedalaman dan sudut bucket.");
  if (avg(reverseLoaded) > 8 || avg(forwardLoaded) > 8) suggestions.push("‚ö†Ô∏è Travel Loaded > 8 detik. Perpendek jarak travel atau tingkatkan kecepatan.");
  if (avg(dumping) > 6) suggestions.push("‚ö†Ô∏è Dumping > 6 detik. Perbaiki posisi dumping atau ketinggian truck.");
  if (avg(reverseEmpty) > 8 || avg(forwardEmpty) > 8) suggestions.push("‚ö†Ô∏è Travel Empty > 8 detik. Perpendek jarak kembali ke material.");

  // Tampilkan hasil
  let outputHTML = `
    <p><strong>Model Wheel Loader:</strong> ${typeAlat}</p>
    <p><strong>Kapasitas Bucket:</strong> ${kapasitas} m¬≥</p>
    <p><strong>Metode Loading:</strong> ${metode}</p>    
    <p><strong>Jenis Material:</strong> ${materialName}</p>
    <p><strong>Density Material:</strong> ${density} ton/m¬≥</p>
    <p><strong>Jumlah Truck:</strong> ${truckCount}</p>
    <hr>
    <p><strong>Total Duration:</strong> ${(totalPrimary + totalSecondary).toFixed(2)} s</p>
    <p><strong>Average Cycle Time:</strong> ${avgCycleTime.toFixed(2)} s</p>
    <p><strong>Primary Times:</strong> ${totalPrimary.toFixed(2)} s</p>
    <p><strong>Average Primary Times:</strong> ${(totalPrimary / (primary.length || 1)).toFixed(2)} s</p>
    <p><strong>Secondary Times:</strong> ${totalSecondary.toFixed(2)} s</p>
    <p><strong>Average Secondary Times:</strong> ${(totalSecondary / (secondary.length || 1)).toFixed(2)} s</p>
    <p><strong>Work Efficiency:</strong> ${(efficiency * 100).toFixed(2)}%</p>
    <p><strong>Average Bucket Fill Factor:</strong> ${avgFill.toFixed(2)}</p>
    <p><strong>Total Bucket Pass:</strong> ${dumpCount}</p>
    <p><strong>Productivity:</strong> ${produksiTon.toFixed(2)} ton/jam</p>
  `;
  
  document.getElementById("output").innerHTML = outputHTML;

  document.getElementById("btnExportPDF").disabled = false;
  document.getElementById("btnExportExcel").disabled = false;
  document.getElementById("btnExportSheets").disabled = false;
  
  // Tampilkan resume langkah
  let resumeHTML = `
    <h3>Resume Pengoperasian:</h3>
    <ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>
    <h3>Summary Langkah:</h3>
    <table>
      <thead>
        <tr><th>Category</th><th>Item</th><th>Durasi (s)</th><th>Bucket Fill Factor</th></tr>
      </thead>
      <tbody>
        ${logs.map(l => `<tr><td>${l.category}</td><td>${l.item}</td><td>${l.durasi.toFixed(2)}</td><td>${l.fillFactor}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
  
  document.getElementById("resume").innerHTML = resumeHTML;

  // Buat grafik pie
  const pieChartCanvas = document.getElementById("pieChart");
  window.pieChart = new Chart(pieChartCanvas, {
    type: 'pie',
    data: {
      labels: ["Primary Work", "Secondary Work"],
      datasets: [{
        data: [totalPrimary, totalSecondary],
        backgroundColor: ["#007bff", "#ffc107"]
      }]
    }
  });
  pieChartCanvas.chart = window.pieChart;

  // Buat grafik bar
  const primaryItems = [...new Set(primary.map(p => p.item))];
  const avgDurasi = primaryItems.map(item => {
    const steps = primary.filter(p => p.item === item);
    return steps.reduce((a,b)=>a+b.durasi,0)/steps.length;
  });

  const barChartCanvas = document.getElementById("barChart");
  window.barChart = new Chart(barChartCanvas, {
    type: 'bar',
    data: {
      labels: primaryItems,
      datasets: [{
        label: "Rata-rata Durasi (detik)",
        data: avgDurasi,
        backgroundColor: "#28a745"
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  barChartCanvas.chart = window.barChart;
}

// Fungsi export tetap sama
// ...
</script>
  
<script src="./chart.js"></script>
<script src="./html2canvas.min.js"></script>
<script src="./jspdf.umd.min.js"></script>
<script src="./jspdf.plugin.autotable.min.js"></script>
<script src="./xlsx.full.min.js"></script>
  
</body>
</html>